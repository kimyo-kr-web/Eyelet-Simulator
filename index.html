<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KIMYO Wallet Customizing</title>

  <!-- Pretendard (한글), Helvetica (영문) -->
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --gap-xl: 8vh;
      --gap-lg: 6vh;
      --gap-md: 4vh;
      --gap-sm: 2vh;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
    html,body{margin:0;height:100%;}
    body{
      background:#000;color:#fff;font-family:'Pretendard','Helvetica',sans-serif;
      display:flex;flex-direction:column;align-items:center;
    }

    /* 헤더 */
    h1{
      font-family:'Helvetica',sans-serif;
      font-weight:700; letter-spacing:.02em;
      font-size: clamp(40px, 12vw, 96px);
      margin: min(10vh,80px) 0 var(--gap-sm);
      line-height:1;
    }
    h2{
      font-weight:600;
      font-size: clamp(18px, 6vw, 36px);
      margin:0 0 var(--gap-lg);
      line-height:1.2;
    }

    /* 안내문 */
    .desc{
      width: min(92vw, 720px);
      text-align:center; line-height:1.5;
      font-size: clamp(13px, 3.8vw, 22px);
      margin-bottom: var(--gap-md);
      color:#fff;
    }

    /* 지갑 영역 (9:6 비율) */
    .wallet-area{
      width:min(92vw, 900px);
      aspect-ratio: 3 / 2;             /* 9:6 = 3:2 */
      border:2px solid #fff;border-radius:14px;
      position:relative; overflow:hidden;
      background:#000;
      margin-bottom: var(--gap-sm);
      touch-action:none;
    }

    /* 하단 주의 문구 */
    .notice{
      width:min(92vw, 900px);
      display:flex; justify-content:space-between; gap:12px;
      font-size: clamp(11px, 3.2vw, 18px);
      color:#aaa; margin-bottom: var(--gap-xl);
    }

    /* 타입 선택 */
    .types{
      display:flex; align-items:center; justify-content:center;
      gap:min(22vw, 140px); margin-bottom: var(--gap-lg);
    }
    .type{
      display:flex; flex-direction:column; align-items:center;
      font-weight:500; font-size: clamp(14px, 4.4vw, 22px);
      user-select:none; cursor:pointer;
    }
    .circle{border:4px solid #fff;border-radius:50%;background:transparent;margin-top:12px;}
    .circle.a{ width:min(16vw, 96px); height:min(16vw, 96px); }
    .circle.b{ width:min(30vw, 180px); height:min(30vw, 180px); }

    /* 입력 */
    .user-input{
      width:min(92vw, 900px);
      height: clamp(44px, 7.2vh, 72px);
      border:2px solid #fff;border-radius:10px;background:transparent;color:#fff;
      font-size: clamp(14px, 4vw, 20px); text-align:center; padding:0 16px;
      margin-bottom: var(--gap-lg);
    }
    .user-input::placeholder{color:#888;}

    /* 버튼 */
    .buttons{display:flex; gap:min(8vw, 36px); width:min(92vw, 900px); margin-bottom: var(--gap-md);}
    .btn{
      flex:1; height: clamp(48px, 7.6vh, 76px);
      font-size: clamp(16px, 4.6vw, 22px); font-weight:700;
      border:none; border-radius:12px; background:#fff; color:#000; cursor:pointer;
    }

    /* 저장 팝업 */
    .popup{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: clamp(64px, 14vh, 180px);
      background:rgba(0,0,0,.85); padding:14px 22px; border-radius:12px;
      font-size: clamp(14px, 4.2vw, 20px);
      display:none; white-space:nowrap;
    }

    /* 스티커(아일렛) */
    .sticker{
      position:absolute; border-radius:50%;
      border:2px solid #fff; background:transparent;  /* 이미지처럼 속 비움 */
      touch-action:none; user-select:none; cursor:grab;
    }
    .sticker:active{cursor:grabbing;}

    /* 작은 삭제 버튼은 UI에 보이지 않게, 탭으로 삭제 */
    .remove-hint{position:absolute; inset:auto auto 6px 6px; font-size:11px; opacity:.6; display:none;}
    .sticker.show-hint .remove-hint{display:block;}
  </style>
</head>
<body>
  <h1>KIMYO</h1>
  <h2>Wallet Customizing</h2>

  <p class="desc">
    검은 사각형은 지갑 영역입니다. 아일렛을 드래그하여 배치하세요.<br />
    아일렛은 총 7개 까지 배치할 수 있어요.
  </p>

  <div class="wallet-area" id="wallet" aria-label="지갑 영역 (9cm × 6cm)"></div>

  <div class="notice">
    <span>* 커스터마이징 시뮬레이터로 실제와 약간의 오차가 발생할 수 있습니다.</span>
    <span>* 실제 9cmX6cm</span>
  </div>

  <div class="types">
    <div class="type" id="typeA">
      Type A
      <div class="circle a" aria-hidden="true"></div>
    </div>
    <div class="type" id="typeB">
      Type B
      <div class="circle b" aria-hidden="true"></div>
    </div>
  </div>

  <input id="userInfo" class="user-input" type="text" placeholder="성함 + 휴대폰 뒷자리" />

  <div class="buttons">
    <button class="btn" id="resetBtn">RESET</button>
    <button class="btn" id="downloadBtn">DOWNLOAD</button>
  </div>

  <div class="popup" id="popup">
    저장 완료! 인스타그램 <b>@kimyo.kr</b> 계정으로 DM 보내주세요.
  </div>

  <script>
    const wallet = document.getElementById('wallet');
    const popup  = document.getElementById('popup');
    const MAX_STICKERS = 7;

    const stickers = [];
    let dragging = null;

    // 타입별 스티커 생성 (지갑 크기 기준 비율)
    function addSticker(type){
      if (stickers.length >= MAX_STICKERS){
        alert('아일렛은 최대 7개까지 추가할 수 있습니다.');
        return;
      }
      const rect = wallet.getBoundingClientRect();
      const size = type === 'A' ? rect.width * 0.09 : rect.width * 0.24; // A=9%, B=24%
      const el = document.createElement('div');
      el.className = 'sticker';
      el.style.width  = size + 'px';
      el.style.height = size + 'px';
      el.style.left   = Math.max(6, rect.width*0.1 - size/2) + 'px';
      el.style.top    = Math.max(6, rect.height*0.2 - size/2) + 'px';
      el.setAttribute('data-size', size);
      el.title = '드래그로 이동 · 탭하면 삭제';

      // 탭(더블탭 유사)로 삭제
      let lastTap = 0;
      el.addEventListener('pointerdown', (e) => {
        const now = Date.now();
        if (now - lastTap < 300){ // 더블탭
          wallet.removeChild(el);
          const i = stickers.indexOf(el);
          if (i > -1) stickers.splice(i,1);
          return;
        }
        lastTap = now;

        const r = el.getBoundingClientRect();
        dragging = {
          el,
          startX: e.clientX,
          startY: e.clientY,
          offsetX: e.clientX - r.left,
          offsetY: e.clientY - r.top
        };
        el.setPointerCapture(e.pointerId);
      });

      el.addEventListener('pointermove', (e)=>{
        if (!dragging || dragging.el !== el) return;
        const wrap = wallet.getBoundingClientRect();
        let x = e.clientX - wrap.left - dragging.offsetX;
        let y = e.clientY - wrap.top  - dragging.offsetY;

        // 경계 안으로 제한
        const w = el.offsetWidth, h = el.offsetHeight;
        x = Math.max(0, Math.min(x, wrap.width  - w));
        y = Math.max(0, Math.min(y, wrap.height - h));

        el.style.left = x + 'px';
        el.style.top  = y + 'px';
      });

      el.addEventListener('pointerup', ()=> dragging = null);
      el.addEventListener('pointercancel', ()=> dragging = null);

      wallet.appendChild(el);
      stickers.push(el);
    }

    document.getElementById('typeA').addEventListener('click', ()=>addSticker('A'));
    document.getElementById('typeB').addEventListener('click', ()=>addSticker('B'));

    // RESET
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      stickers.forEach(s => s.remove());
      stickers.length = 0;
    });

    // DOWNLOAD (지갑 영역만 캡처 + 입력 텍스트 포함)
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const userInfo = document.getElementById('userInfo').value.trim();
      const temp = document.createElement('div');
      temp.textContent = userInfo;
      temp.style.position='absolute';
      temp.style.bottom='10px';
      temp.style.left='50%';
      temp.style.transform='translateX(-50%)';
      temp.style.fontSize='clamp(12px, 3.8vw, 18px)';
      temp.style.color='#fff';
      temp.style.pointerEvents='none';
      wallet.appendChild(temp);

      html2canvas(wallet,{useCORS:true,backgroundColor:null,scale:2}).then(canvas=>{
        wallet.removeChild(temp);
        const a = document.createElement('a');
        a.download = 'wallet-custom.png';
        a.href = canvas.toDataURL('image/png');
        a.click();

        popup.style.display='block';
        setTimeout(()=> popup.style.display='none', 2800);
      });
    });

    // 창 크기 바뀌면 스티커 크기도 비율 유지
    new ResizeObserver(() => {
      const rect = wallet.getBoundingClientRect();
      stickers.forEach(el=>{
        const was = parseFloat(el.getAttribute('data-size')); // 이전 기준 너비(px)
        const typeScale = (was / was) || 1; // placeholder
        // 타입 추정: 크기 비율로 판별
        const isA = el.offsetWidth < rect.width * 0.16;
        const size = isA ? rect.width*0.09 : rect.width*0.24;
        const leftRatio = parseFloat(el.style.left) / (rect.width || 1);
        const topRatio  = parseFloat(el.style.top)  / (rect.height|| 1);
        el.style.width = size+'px';
        el.style.height= size+'px';
        el.style.left  = (leftRatio * rect.width) + 'px';
        el.style.top   = (topRatio  * rect.height)+ 'px';
        el.setAttribute('data-size', size);
      });
    }).observe(wallet);
  </script>
</body>
</html>
